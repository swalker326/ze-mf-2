"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupZeDeploy = void 0;
const tslib_1 = require("tslib");
const process = tslib_1.__importStar(require("node:process"));
const ze_rspack_upload_agent_1 = require("./ze-rspack-upload-agent");
const zephyr_xpack_internal_1 = require("zephyr-xpack-internal");
function setupZeDeploy(pluginOptions, compiler) {
    const { pluginName } = pluginOptions;
    compiler.hooks.thisCompilation.tap(pluginName, (compilation) => {
        compilation.hooks.processAssets.tapPromise({
            name: pluginName,
            stage: compiler.webpack.Compilation.PROCESS_ASSETS_STAGE_REPORT,
        }, async (assets) => {
            const stats = compilation.getStats();
            const stats_json = compilation.getStats().toJson();
            await pluginOptions.zephyr_engine.start_new_build();
            process.nextTick(ze_rspack_upload_agent_1.rspack_zephyr_agent, {
                stats,
                stats_json,
                assets,
                pluginOptions,
            });
            if (!pluginOptions.wait_for_index_html) {
                await (0, zephyr_xpack_internal_1.onDeploymentDone)();
            }
            // empty line to separate logs from other plugins
            console.log();
        });
    });
}
exports.setupZeDeploy = setupZeDeploy;
//# sourceMappingURL=ze-setup-ze-deploy.js.map