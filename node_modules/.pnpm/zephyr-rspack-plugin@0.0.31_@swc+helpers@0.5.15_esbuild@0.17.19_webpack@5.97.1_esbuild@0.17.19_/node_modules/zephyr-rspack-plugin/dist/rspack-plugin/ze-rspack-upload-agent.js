"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rspack_zephyr_agent = void 0;
const zephyr_agent_1 = require("zephyr-agent");
const zephyr_xpack_internal_1 = require("zephyr-xpack-internal");
async function rspack_zephyr_agent({ stats, stats_json, assets, pluginOptions, }) {
    (0, zephyr_agent_1.ze_log)('Initiating: Zephyr Rspack Upload Agent');
    const zeStart = Date.now();
    const { wait_for_index_html, zephyr_engine } = pluginOptions;
    try {
        const assetsMap = await (0, zephyr_xpack_internal_1.buildWebpackAssetMap)(assets, {
            wait_for_index_html,
        });
        // rspack dash data
        const { EDGE_URL, PLATFORM } = await zephyr_engine.application_configuration;
        const dashData = await (0, zephyr_xpack_internal_1.getBuildStats)({
            stats,
            stats_json,
            assets,
            pluginOptions,
            EDGE_URL,
            PLATFORM,
        });
        await zephyr_engine.upload_assets({
            assetsMap,
            mfConfig: pluginOptions.mfConfig,
            buildStats: dashData,
        });
    }
    catch (err) {
        (0, zephyr_agent_1.logFn)('error', zephyr_agent_1.ZephyrError.format(err));
    }
    finally {
        (0, zephyr_xpack_internal_1.emitDeploymentDone)();
        // todo: log end
        (0, zephyr_agent_1.ze_log)('Zephyr Rspack Upload Agent: Done in', Date.now() - zeStart, 'ms');
    }
}
exports.rspack_zephyr_agent = rspack_zephyr_agent;
//# sourceMappingURL=ze-rspack-upload-agent.js.map